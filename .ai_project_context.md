# AI Project Context: OBP Scala Library

**Last Updated**: 2025-09-10  
**Project Status**: ‚úÖ Active Development - Publishing Pipeline Fixed & Verified  
**Current Version**: 0.1.0-SNAPSHOT

## üìã Project Overview

### Purpose
Open Bank Project (OBP) Scala Library - A utility library for Scala applications working with the Open Bank Project API ecosystem.

### Key Technologies
- **Language**: Scala (cross-compiled)
- **Build Tool**: SBT 1.9.0
- **Scala Versions**: 2.12.17, 2.13.14, 3.3.1
- **Repository**: Nexus (Sonatype)
- **Containerization**: Docker + Docker Compose
- **Testing**: ScalaTest 3.2.19

### Repository Structure
```
OBP-Scala-Library/
‚îú‚îÄ‚îÄ .ai_project_context.md          # This file - AI assistant context
‚îú‚îÄ‚îÄ build.sbt                       # Main SBT build configuration
‚îú‚îÄ‚îÄ .env                            # Environment variables (gitignored)
‚îú‚îÄ‚îÄ source-env.sh                   # Convenience script for loading .env
‚îú‚îÄ‚îÄ .gitignore                      # Git ignore rules
‚îú‚îÄ‚îÄ README.md                       # Main project documentation
‚îú‚îÄ‚îÄ CREDENTIALS_QUICKSTART.md       # Quick setup guide for credentials
‚îú‚îÄ‚îÄ LICENSE                         # AGPL-3.0 license
‚îú‚îÄ‚îÄ src/                            # Source code
‚îÇ   ‚îî‚îÄ‚îÄ main/scala/                 # Scala source files
‚îú‚îÄ‚îÄ scripts/                        # Utility scripts
‚îÇ   ‚îú‚îÄ‚îÄ setup-credentials.sh        # Interactive credential setup
‚îÇ   ‚îî‚îÄ‚îÄ publish-all.sh              # Publish to all Scala versions
‚îú‚îÄ‚îÄ docker/                         # Docker configuration
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml          # Nexus + SBT services
‚îÇ   ‚îî‚îÄ‚îÄ sbt/Dockerfile              # Custom SBT container
‚îú‚îÄ‚îÄ docs/                           # Additional documentation
‚îú‚îÄ‚îÄ project/                        # SBT project configuration
‚îú‚îÄ‚îÄ target/                         # Build artifacts (gitignored)
‚îú‚îÄ‚îÄ java-example-app/               # Java integration example
‚îî‚îÄ‚îÄ scala-example-app/              # Scala usage example
```

## üîß Build Configuration

### Key Build Settings (build.sbt)
- **Organization**: `org.openbankproject`
- **Cross-compilation**: Scala 2.12.17, 2.13.14, 3.3.1
- **Version**: `0.1.0-SNAPSHOT` (for snapshots repo)
- **Repository**: Configured for Nexus with environment-based credentials

### Publishing Configuration
- **Snapshots**: `http://nexus:8081/repository/maven-snapshots/`
- **Releases**: `http://nexus:8081/repository/maven-releases/`
- **Credentials**: Environment variables (NEXUS_USERNAME, NEXUS_PASSWORD, etc.)

## üê≥ Development Environment

### Docker Setup
- **Nexus Container**: `sonatype/nexus3:latest` on port 8081
- **SBT Container**: Custom container with SBT 1.9.0
- **Network**: Internal docker network for service communication

### Environment Variables (.env)
```bash
NEXUS_USERNAME=admin
NEXUS_PASSWORD=[password]
NEXUS_HOST=nexus
NEXUS_URL=http://nexus:8081/
```

## üöÄ Common Workflows

### Quick Commands
```bash
# Setup credentials
./scripts/setup-credentials.sh

# Publish to all Scala versions
./scripts/publish-all.sh

# Publish to specific version
./scripts/publish-all.sh --version 2.13.14

# Start development environment (comprehensive)
cd docker && ./start-dev.sh

# Start development environment (fast - skips all optional tests)
cd docker && ./start-dev.sh --fast

# Start development environment (skip only Nexus publishing)
cd docker && ./start-dev.sh --skip-nexus

# Start development environment (skip only cross-compilation)
cd docker && ./start-dev.sh --skip-cross

# Start development environment (skip only Ivy publishing)
cd docker && ./start-dev.sh --skip-ivy

# Start development environment (skip only Maven publishing)
cd docker && ./start-dev.sh --skip-maven

# Manual Docker commands
source .env && cd docker && docker-compose run --rm -T \
  -e NEXUS_USERNAME="$NEXUS_USERNAME" \
  -e NEXUS_PASSWORD="$NEXUS_PASSWORD" \
  -e NEXUS_HOST="$NEXUS_HOST" \
  -e NEXUS_URL="$NEXUS_URL" \
  sbt sbt "++2.13.14" "publish"

# Run tests
sbt test

# Local development
sbt publishLocal       # Publish to local Ivy repository (~/.ivy2/local/)
sbt publishM2          # Publish to local Maven repository (~/.m2/repository/)
```

### Development Workflow
1. Make code changes in `src/main/scala/`
2. Quick validation: `cd docker && ./start-dev.sh --fast`
3. Full testing (optional): `cd docker && ./start-dev.sh`
4. Publish to repository: `./scripts/publish-all.sh`

### Performance Options
- **Fast development**: Use `./start-dev.sh --fast` to skip all optional tests (Nexus, cross-compilation, Ivy and Maven publishing)
- **Skip Nexus only**: Use `./start-dev.sh --skip-nexus` to test compilation/tests but skip Nexus publishing
- **Skip cross-compilation**: Use `./start-dev.sh --skip-cross` to test only default Scala version
- **Skip Ivy only**: Use `./start-dev.sh --skip-ivy` to skip local Ivy repository publishing
- **Skip Maven only**: Use `./start-dev.sh --skip-maven` to skip local Maven repository publishing
- **Full comprehensive**: Use `./start-dev.sh` for complete testing including all Scala versions, Nexus, Ivy and Maven publishing

### Local Artifact Locations
- **Ivy artifacts**: `~/.ivy2/local/org/openbankproject/` (for SBT projects)
- **Maven artifacts**: `~/.m2/repository/org/openbankproject/` (for Maven/Gradle projects - **available on local machine**)
- **Remote artifacts**: `http://localhost:8081/repository/maven-snapshots/org/openbankproject/` (via Nexus)

### Maven/Gradle Integration
After running `sbt +publishM2`, artifacts are available at:
```
~/.m2/repository/org/openbankproject/obp-scala-library_2.12/0.1.0-SNAPSHOT/
~/.m2/repository/org/openbankproject/obp-scala-library_2.13/0.1.0-SNAPSHOT/
~/.m2/repository/org/openbankproject/obp-scala-library_3/0.1.0-SNAPSHOT/
```

**Maven dependency**:
```xml
<dependency>
    <groupId>org.openbankproject</groupId>
    <artifactId>obp-scala-library_2.13</artifactId>
    <version>0.1.0-SNAPSHOT</version>
</dependency>
```

**Gradle dependency**:
```gradle
implementation 'org.openbankproject:obp-scala-library_2.13:0.1.0-SNAPSHOT'
```

## üîç Recent Changes & Current Status

### ‚úÖ Recently Fixed (2025-09-10)
- **Code Reflection Issue**: Fixed `get_scala_versions()` function that was outputting debug messages to stdout instead of stderr
- **Environment Loading**: Fixed .env file path resolution to use project root directory consistently
- **Nexus Connectivity**: Improved Nexus readiness checks with proper API endpoints and extended timeouts
- **Publishing Pipeline**: Verified that new code changes are properly reflected in published artifacts
- **Integration Testing**: Created and validated end-to-end testing to ensure published artifacts work correctly
- **start-dev.sh Environment**: Fixed environment variable loading and passing to Docker containers
- **Docker Container Publishing**: Both `publish-all.sh` and `start-dev.sh` now properly publish to Nexus
- **Performance Options**: Added `--fast`, `--skip-nexus`, `--skip-cross`, `--skip-ivy`, and `--skip-maven` options to start-dev.sh for faster development cycles
- **Local Repository Mounts**: Added Docker volume mounts for ~/.m2 and ~/.ivy2 so artifacts are available on local machine
- **Maven Integration**: Complete local Maven repository support with volume mounting for immediate use in Maven/Gradle projects
- **URL Generation**: Fixed artifact path display to show complete URLs instead of relative paths

### ‚úÖ Previously Fixed (2025-01-09)
- **Version Issue**: Changed from `0.1.0` to `0.1.0-SNAPSHOT` to fix Nexus HTTP 400 error
- **Publishing Pipeline**: Successfully tested cross-compilation to all Scala versions
- **Automation**: Created `publish-all.sh` script for easy publishing
- **Documentation**: Updated CREDENTIALS_QUICKSTART.md with correct commands

### üéØ Current State
- ‚úÖ Environment setup working
- ‚úÖ Docker configuration functional
- ‚úÖ Cross-compilation working (2.12, 2.13, 3.x)
- ‚úÖ Publishing to Nexus snapshots successful
- ‚úÖ Credential management secure and automated
- ‚úÖ New code changes properly reflected in published artifacts
- ‚úÖ End-to-end integration testing validated
- ‚úÖ Scala version extraction from build.sbt working correctly
- ‚úÖ start-dev.sh script fully functional with Nexus publishing
- ‚úÖ Environment variable handling consistent across all scripts
- ‚úÖ Performance options available for faster development workflow
- ‚úÖ Complete artifact URLs generated for easy browsing
- ‚úÖ Local Maven and Ivy repositories mounted for direct access from host machine
- ‚úÖ Maven/Gradle integration tested and working with local artifacts

## ‚ö†Ô∏è Important Notes

### Version Management
- **Snapshots**: Must end with `-SNAPSHOT` for maven-snapshots repo
- **Releases**: No `-SNAPSHOT` suffix for maven-releases repo
- **Current**: Using snapshots for development (0.1.0-SNAPSHOT)

### Security
- Credentials stored in `.env` (gitignored)
- File permissions set to 600 for security
- Environment variables used in build configuration
- No hardcoded passwords in source code

### Common Issues & Solutions
| Issue | Solution |
|-------|----------|
| HTTP 400 from Nexus | Check version matches repository type (SNAPSHOT vs release) |
| "Command not found" in Docker | Use proper docker-compose syntax with quoted arguments |
| Missing credentials | Run `./scripts/setup-credentials.sh` |
| Connection refused | Start Nexus: `cd docker && docker-compose up -d nexus` |
| Debug messages in version list | Fixed: get_scala_versions() now outputs debug to stderr |
| Code changes not reflected | Fixed: Proper working directory and environment loading |
| Nexus not ready errors | Fixed: Improved readiness checks with proper API endpoints |
| start-dev.sh publish failures | Fixed: Environment variables now properly exported and passed |
| Docker container env issues | Fixed: Consistent env handling across publish-all.sh and start-dev.sh |
| start-dev.sh too slow | Fixed: Added --fast, --skip-nexus, --skip-cross, --skip-ivy, --skip-maven options for faster development |
| Relative artifact paths | Fixed: Complete URLs now generated for easy artifact browsing |
| Maven artifacts in container only | Fixed: Volume mounts for ~/.m2 and ~/.ivy2 make artifacts available on local machine |

## üìö Documentation Files

### Key Documentation
- `README.md` - Main project overview and setup
- `CREDENTIALS_QUICKSTART.md` - Fast credential setup guide
- `docs/` - Additional detailed documentation
- `.ai_project_context.md` - This context file for AI assistant

### Generated Files
- `source-env.sh` - Auto-generated by setup script
- `target/` - SBT build artifacts
- `.metals/` - Metals LSP cache

## üß™ Testing & Quality

### Test Framework
- ScalaTest 3.2.19
- Located in `src/test/scala/`
- Run with: `sbt test`

### Code Quality
- Cross-compilation ensures compatibility
- Automated publishing pipeline
- Version management best practices

## üîÑ Maintenance Tasks

### Regular Updates
- Update Scala versions in `crossScalaVersions`
- Update dependency versions
- Update this context file when major changes occur
- Review and update documentation
- Test integration after significant changes

### Verified Working (2025-09-10)
- ‚úÖ Code changes are immediately reflected in published artifacts
- ‚úÖ Version extraction from build.sbt works correctly
- ‚úÖ Environment variables load properly from project root
- ‚úÖ Nexus connectivity checks are reliable
- ‚úÖ Integration testing confirms end-to-end functionality
- ‚úÖ start-dev.sh successfully publishes to Nexus for all Scala versions
- ‚úÖ Both development and production publishing workflows are functional
- ‚úÖ Performance options available: --fast (20s), --skip-maven (35s), --skip-ivy (40s), --skip-nexus (70s), full mode (160s)
- ‚úÖ Local repository volumes mounted: Maven (~/.m2) and Ivy (~/.ivy2) accessible on host machine
- ‚úÖ Complete artifact URLs generated for direct browsing
- ‚úÖ Maven/Gradle projects can immediately use artifacts published via `sbt +publishM2`

### Monitoring
- Check Nexus repository for published artifacts
- Monitor Docker container health
- Verify cross-compilation continues working

---

## ü§ñ AI Assistant Instructions

When working on this project:

1. **Always check** the current version in `build.sbt` and ensure it matches the intended repository
2. **Use the scripts** in `scripts/` directory for common tasks
3. **Follow the Docker workflow** for publishing - don't try to run SBT directly on host
4. **Update this file** when making significant changes to project structure or workflow
5. **Check recent changes section** to understand current project state
6. **Refer to documentation** in README.md and CREDENTIALS_QUICKSTART.md for user-facing instructions
7. **Code changes are immediately reflected** - the publishing pipeline now works correctly
8. **Test integration** when making significant library changes using test-integration directory
9. **Both scripts work** - publish-all.sh and start-dev.sh both handle publishing correctly
10. **Use performance options** - start-dev.sh --fast for quick development, full mode for comprehensive testing

### Quick Project Assessment Checklist
- [ ] Check `build.sbt` version format (SNAPSHOT vs release)
- [ ] Verify `.env` file exists and has correct format
- [ ] Confirm Docker containers can start
- [ ] Test publishing pipeline works
- [ ] Validate cross-compilation for all Scala versions
- [ ] Check documentation is up to date
- [ ] Verify code changes are reflected in published artifacts
- [ ] Test integration with published artifacts works
- [ ] Confirm both publish-all.sh and start-dev.sh work with Nexus
- [ ] Test performance options: --fast, --skip-nexus, --skip-cross, --skip-ivy, --skip-maven work as expected
- [ ] Verify artifact URLs are complete and browseable

**Remember**: This project uses Docker-based publishing exclusively. Always use the containerized workflow rather than direct SBT commands on the host system.